<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WinZone - Admin Control Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-color: #4e73df;
            --secondary-color: #224abe;
            --bg-light: #f8f9fc;
            --text-dark: #5a5c69;
            --success: #1cc88a;
            --warning: #f6c23e;
            --danger: #e74a3b;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color) 10%, var(--secondary-color) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            opacity: 0.8;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            opacity: 1;
            border-left: 4px solid white;
        }

        .nav-item i {
            margin-right: 15px;
            width: 20px;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            height: 70px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
        }

        .page-content {
            padding: 30px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* Dashboard Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-text h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .stat-text h2 {
            margin: 5px 0 0;
            color: #333;
            font-size: 1.5rem;
        }

        .stat-icon {
            font-size: 2rem;
            color: #dddfeb;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background: #f8f9fc;
            padding: 12px;
            text-align: left;
            font-size: 0.85rem;
            color: var(--text-dark);
            text-transform: uppercase;
            border-bottom: 2px solid #e3e6f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e3e6f0;
            color: #333;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        /* Buttons */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Sections Visibility */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }


        .modal-overlay {
            display: none;
            /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparent black */
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }

        .close-modal:hover {
            color: #000;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            /* Important for padding */
        }

        .modal-footer {
            text-align: right;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand"><i class="fa-solid fa-crown"></i> WinZone</div>

        <div class="nav-item active" onclick="showSection('dashboard')">
            <i class="fa-solid fa-gauge-high"></i> Dashboard
        </div>
        <div class="nav-item" onclick="showSection('users')">
            <i class="fa-solid fa-users"></i> User Management
        </div>
        <div class="nav-item" onclick="showSection('draws')">
            <i class="fa-solid fa-dice"></i> Live Draw Control
        </div>
        <div class="nav-item" onclick="showSection('reports')">
            <i class="fa-solid fa-chart-line"></i> Sales Reports
        </div>
        <div class="nav-item" style="margin-top: auto; background: var(--danger);" onclick="logout()">
            <i class="fa-solid fa-sign-out-alt"></i> Logout
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h2 id="page-title" style="margin: 0; color: #333;">Dashboard Overview</h2>
            <div class="user-profile">
                <span>Welcome, <b>Admin</b></span>
            </div>
        </div>

        <!-- Content Area -->
        <div class="page-content">

            <!-- 1. DASHBOARD SECTION -->
            <div id="dashboard" class="section active">
                <div class="cards-grid">
                    <div class="stat-card" style="border-left-color: var(--primary-color);">
                        <div class="stat-text">
                            <h4>Total Retailers</h4>
                            <h2 id="total-users">0</h2>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-text">
                            <h4>Today's Sale</h4>
                            <h2 id="today-sale">₹0.00</h2>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning);">
                        <div class="stat-text">
                            <h4>Pending Draw</h4>
                            <h2 id="next-draw-time">--:--</h2>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-clock"></i></div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger);">
                        <div class="stat-text">
                            <h4>Net Profit (Today)</h4>
                            <h2 id="today-profit">₹0.00</h2>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-chart-pie"></i></div>
                    </div>
                </div>

                <div class="table-container">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
                    <table id="recent-activity-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS will populate --></tbody>
                    </table>
                </div>
            </div>

            <!-- 2. USER MANAGEMENT SECTION -->
            <div id="users" class="section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <h3>All Retailers</h3>
                    <button class="btn btn-primary" onclick="openAddUserModal()"><i class="fa-solid fa-plus"></i> Add
                        New User</button>
                </div>
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Balance</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS will populate --></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. LIVE DRAW CONTROL -->
            <div id="draws" class="section">
                <h3>Live Draw Management</h3>
                <div class="table-container">
                    <div
                        style="padding: 20px; text-align: center; background: #e8eaed; border-radius: 8px; margin-bottom: 20px;">
                        <h2>Next Draw: <span id="admin-timer" style="color: var(--danger);">09:59</span></h2>
                        <p>Total Collection so far: <strong id="live-collection">₹0.00</strong></p>
                    </div>
                    <button class="btn btn-primary" onclick="openResultsModal()">
                        <i class="fa-solid fa-history"></i> View Result History
                    </button>

                    <h4>Result Override (Use with Caution)</h4>
                    <p style="font-size: 0.9rem; color: #666;">Select a spot to FORCE it as the winner for the current
                        pending draw.</p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <select id="manual-winner-select" style="padding: 10px; width: 200px;">
                            <option value="">-- Select Winner --</option>
                            <option value="A0">A0</option>
                            <option value="B1">B1</option>
                            <option value="C2">C2</option>
                            <option value="D3">D3</option>
                            <option value="E4">E4</option>
                            <option value="F5">F5</option>
                            <option value="G6">G6</option>
                            <option value="H7">H7</option>
                            <option value="I8">I8</option>
                            <option value="J9">J9</option>
                        </select>
                        <button class="btn btn-danger" onclick="forceWinner()">Set Winner</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ADD USER MODAL (Hidden by default) -->
    <div id="add-user-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Retailer</h3>
                <span class="close-modal" onclick="closeAddUserModal()">&times;</span>
            </div>

            <form id="add-user-form" onsubmit="submitNewUser(event)">
                <div class="input-group">
                    <label>User ID (Username)</label>
                    <input type="text" id="new-username" placeholder="e.g. Aman01" required
                        pattern="^(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{4,}$"
                        title="Must contain at least 1 uppercase letter, 1 number, and be 4+ chars">
                    <small style="color: #888; font-size: 0.8rem;">Min 4 chars, 1 Upper, 1 Digit</small>
                </div>

                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="new-password" placeholder="Secure Password" required>
                </div>

                <div class="input-group">
                    <label>Store Address</label>
                    <textarea id="new-address" placeholder="Store location..." required rows="2"></textarea>
                </div>

                <div class="input-group">
                    <label>Contact No.</label>
                    <input type="tel" id="new-contact" placeholder="10-digit Mobile Number" required
                        pattern="[0-9]{10}">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn" style="background: #ddd; margin-right: 10px;"
                        onclick="closeAddUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- RESULT HISTORY MODAL (Copied from Retailer App as requested) -->
    <div id="results-modal" class="modal-overlay"
        style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div class="modal-content"
            style="background: white; padding: 0; border-radius: 8px; width: 90%; max-width: 1000px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden;">

            <!-- Header -->
            <header class="header-bar"
                style="background-color: #1f232a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ff8c00;">
                <h1 style="color: #f1f1f1; font-size: 1.5rem; margin: 0;">
                    <i class="fa-solid fa-trophy" style="color: #ff8c00; margin-right: 10px;"></i> Draw History
                </h1>
                <span onclick="closeResultsModal()"
                    style="font-size: 2rem; color: #aaa; cursor: pointer;">&times;</span>
            </header>

            <div class="main-content" style="padding: 20px; background-color: #2c313a; color: white;">

                <!-- Filters -->
                <div class="filter-controls"
                    style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; background: #1f232a; padding: 15px; border-radius: 8px; border: 1px solid #444;">
                    <label style="color: #f1f1f1; font-weight: 500;">Filter by Date:</label>
                    <input type="date" id="result-date-filter"
                        style="padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2c313a; color: white;">
                    <button onclick="loadTodayResults()"
                        style="background-color: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Today's Results
                    </button>
                </div>

                <!-- Table -->
                <div class="table-container"
                    style="max-height: 400px; overflow-y: auto; border: 1px solid #444; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background-color: #ff8c00; color: #1f232a;">
                            <tr>
                                <th style="padding: 12px; text-align: center;">Draw ID</th>
                                <th style="padding: 12px; text-align: center;">End Time</th>
                                <th style="padding: 12px; text-align: center;">Winning Spot</th>
                                <th style="padding: 12px; text-align: center;">Collection</th>
                                <th style="padding: 12px; text-align: center;">Payout</th>
                                <th style="padding: 12px; text-align: center;">Profit</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- JS will populate rows here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="/admin_dashboard.js"></script>
    <script>
        // Simple tab switching logic
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Update Title
            const titles = { 'dashboard': 'Dashboard Overview', 'users': 'User Management', 'draws': 'Live Draw Control', 'reports': 'Sales Reports' };
            document.getElementById('page-title').innerText = titles[sectionId];
        }

        async function logout() {
            try {
                // Call the logout API to clear session on server
                const res = await fetch('/api/logout', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    // Clear client-side storage if any
                    sessionStorage.clear();
                    // Redirect to the login page (root route)
                    window.location.href = '/';
                } else {
                    alert('Logout failed');
                }
            } catch (err) {
                console.error('Logout error:', err);
                // Fallback redirect
                window.location.href = '/';
            }
        }
    </script>
</body>

</html>